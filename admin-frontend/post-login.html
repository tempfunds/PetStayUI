<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Redirecting...</title>
  <script src="https://cdn.jsdelivr.net/npm/aws-amplify@latest/dist/aws-amplify.min.js"></script>
  <script src="/assets/js/config.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin-top: 100px;
    }
    .error {
      color: red;
      font-weight: bold;
    }
  </style>
</head>

<body>
  <h2 id="statusMsg">Logging you in... Please wait.</h2>

  <script>
    function showError(message) {
      console.error(message);
      const status = document.getElementById("statusMsg");
      status.innerHTML = `<span class="error">${message}</span>`;
    }

    window.addEventListener('load', async () => {
      // 1Ô∏è‚É£ Check config.js
      if (!window.PETSTAY_CONFIG) {
        showError("System configuration not loaded. Please refresh or contact support.");
        return;
      }

      // 2Ô∏è‚É£ Check Amplify
      const Amplify = window.aws_amplify?.Amplify;
      const Auth = window.aws_amplify?.Auth;
      if (!Amplify || !Auth) {
        showError("AWS Amplify not loaded. Please try again later.");
        return;
      }

      // 3Ô∏è‚É£ Configure Amplify
      Amplify.configure({
        Auth: {
          region: window.PETSTAY_CONFIG.AWS_REGION,
          userPoolId: window.PETSTAY_CONFIG.COGNITO_USER_POOL_ID,
          userPoolWebClientId: window.PETSTAY_CONFIG.COGNITO_USER_POOL_CLIENT_ID,
          oauth: {
            domain: window.PETSTAY_CONFIG.COGNITO_DOMAIN,
            scope: ['email', 'openid', 'phone'],
            redirectSignIn: window.PETSTAY_CONFIG.REDIRECT_SIGN_IN_URL,
            redirectSignOut: window.PETSTAY_CONFIG.REDIRECT_SIGN_OUT_URL,
            responseType: 'code'
          }
        }
      });

      try {
        console.log("üîÑ Handling OAuth redirect...");

        // 4Ô∏è‚É£ Try to get user ‚Äî retry if necessary
        let user;
        for (let i = 0; i < 5; i++) {
          try {
            user = await Auth.currentAuthenticatedUser({ bypassCache: true });
            if (user) break;
          } catch {
            console.warn(`Retrying user fetch... attempt ${i + 1}`);
            await new Promise(r => setTimeout(r, 1000));
          }
        }
        if (!user) {
          showError("Login session could not be established. Please refresh and try again.");
          return;
        }

        // 5Ô∏è‚É£ Try to get session ‚Äî retry if necessary
        let session;
        for (let i = 0; i < 5; i++) {
          try {
            session = await Auth.currentSession();
            if (session) break;
          } catch {
            console.warn(`Retrying session fetch... attempt ${i + 1}`);
            await new Promise(r => setTimeout(r, 1000));
          }
        }
        if (!session) {
          showError("Session tokens not available yet. Please refresh.");
          return;
        }

        // 6Ô∏è‚É£ Get email from token
        const idToken = session.getIdToken();
        const email = (idToken.payload.email || idToken.payload["cognito:username"] || "unknown").toLowerCase();

        // 7Ô∏è‚É£ Parse query/session params
        const urlParams = new URLSearchParams(window.location.search);
        const bookingId = urlParams.get("bookingId") || sessionStorage.getItem("bookingId");
        const fromLogin = urlParams.get("fromLogin") || sessionStorage.getItem("fromLogin");

        sessionStorage.removeItem("bookingId");
        sessionStorage.removeItem("fromLogin");

        // 8Ô∏è‚É£ Email allowlist
        const allowedStaff = ["petstayteam@outlook.com", "petstayteam@gmail.com"];
        const normalizedAllowed = allowedStaff.map(e => e.trim().toLowerCase());
        if (!normalizedAllowed.includes(email)) {
          alert(`You (${email}) are not authorized to check in guests.`);
          const redirect = bookingId
            ? `${window.PETSTAY_CONFIG.REDIRECT_SIGN_IN_URL.replace('/post-login.html', '/checkin.html')}?bookingId=${bookingId}&status=unauthorized`
            : window.PETSTAY_CONFIG.REDIRECT_SIGN_OUT_URL;
          window.location.href = redirect;
          return;
        }

        // 9Ô∏è‚É£ Redirect to correct page
        if (bookingId && fromLogin === "1") {
          console.log(`‚úÖ QR login detected ‚Üí redirecting to check-in for booking: ${bookingId}`);
          window.location.href = `${window.PETSTAY_CONFIG.REDIRECT_SIGN_IN_URL.replace('/post-login.html', '/checkin.html')}?bookingId=${bookingId}&fromLogin=1`;
        } else {
          console.log("‚úÖ Regular login ‚Üí redirecting to admin dashboard");
          window.location.href = "/admin-frontend/admin_dashboard.html";
        }

      } catch (err) {
        console.error("‚ùå Login error:", err);
        showError("Login failed. Redirecting...");
        setTimeout(() => {
          window.location.href = window.PETSTAY_CONFIG.REDIRECT_SIGN_OUT_URL;
        }, 2000);
      }
    });
  </script>
</body>
</html>
