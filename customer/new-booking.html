<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>New Booking | PetStay</title>
  <link rel="stylesheet" href="../assets/css/bootstrap.min.css" />
  <link rel="stylesheet" href="../assets/css/main.css" />
  <link rel="stylesheet" href="../assets/css/customer.css" />
  <script src="/assets/js/config.js"></script>
  <!-- QR Code library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>
<div class="booking-wrapper">
  <main class="main-wrapper">
    <section class="tab-components">
      <div class="container">
        <div class="title-wrapper text-center pt-4">
          <h2>Book Your Pet With Us!</h2>
          <p>A new pet stay reservation</p>
        </div>

        <div class="form-elements-wrapper mt-4" id="formSection">
          <div class="card-style">
            <form id="bookingForm">
              <!-- Owner Info -->
              <h5 class="mb-3">Owner Information</h5>
              <div class="row g-3">
                <div class="col-md-4">
                  <div class="input-style-1">
                    <label>Owner Name</label>
                    <input id="ownerName" type="text" name="OwnerName" placeholder="Owner Name" required />
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="input-style-1">
                    <label>Email Address</label>
                    <input id="email" type="email" name="Email" placeholder="owner@example.com" required />
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="input-style-1">
                    <label>Phone Number</label>
                    <input id="phoneNumber" type="tel" name="PhoneNumber" placeholder="+1 234 567 8900" required />
                  </div>
                </div>
              </div>

              <!-- Pet Info -->
              <h5 class="mt-4 mb-3">Pet Information</h5>
              <div class="row g-3">
                <div class="col-md-6">
                  <div class="input-style-1">
                    <label>Pet Photo</label>
                    <input type="file" id="photoUpload" name="petPhoto" accept="image/jpeg,image/png" />
                    <small class="text-muted">Only JPG or PNG files, max 5MB.</small>
                    <div id="photoPreview" class="mt-2"></div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="input-style-1">
                    <label>Pet Name</label>
                    <input id="petName" type="text" name="PetName" placeholder="Pet Name" required />
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="select-style-1">
                    <label>Pet Species</label>
                    <div class="select-position">
                      <select id="petSpecies" name="PetSpecies" required>
                        <option value="">Select Species</option>
                        <option>Dog</option>
                        <option>Cat</option>
                      </select>
                    </div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="input-style-1">
                    <label>Pet Breed</label>
                    <input id="petBreed" type="text" name="PetBreed" placeholder="Pet Breed" />
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="input-style-1">
                    <label>Pet Age (in years)</label>
                    <input id="petAge" type="number" name="PetAge" placeholder="e.g., 2" min="0" step="0.1" required />
                  </div>
                </div>
              </div>

              <!-- Booking Details -->
              <h5 class="mt-4 mb-3">Booking Details</h5>
              <div class="row g-3">
                <div class="col-md-4">
                  <div class="input-style-1">
                    <label>Check-In Date</label>
                    <input id="checkInDate" type="date" name="CheckInDate" required />
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="input-style-1">
                    <label>Check-Out Date</label>
                    <input id="checkOutDate" type="date" name="CheckOutDate" required />
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="select-style-1">
                    <label>Time of Arrival</label>
                    <div class="select-position">
                      <select id="arrivalTime" name="ArrivalTime" required>
                        <option value="">Select Time</option>
                        <option value="09:00">09:00 AM</option>
                        <option value="09:30">09:30 AM</option>
                        <option value="10:00">10:00 AM</option>
                        <option value="10:30">10:30 AM</option>
                        <option value="11:00">11:00 AM</option>
                        <option value="11:30">11:30 AM</option>
                        <option value="12:00">12:00 PM</option>
                        <option value="12:30">12:30 PM</option>
                        <option value="13:00">01:00 PM</option>
                        <option value="13:30">01:30 PM</option>
                        <option value="14:00">02:00 PM</option>
                        <option value="14:30">02:30 PM</option>
                        <option value="15:00">03:00 PM</option>
                        <option value="15:30">03:30 PM</option>
                        <option value="16:00">04:00 PM</option>
                        <option value="16:30">04:30 PM</option>
                        <option value="17:00">05:00 PM</option>
                      </select>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Upload Progress -->
              <div id="uploadProgress" class="progress mt-3 d-none">
                <div class="progress-bar" role="progressbar" style="width: 0%">0%</div>
              </div>

              <!-- Status Message -->
              <div id="statusMessage" class="d-none"></div>

              <div class="text-center mt-4">
                <button type="submit" class="main-btn primary-btn btn-hover">Book Now</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </section>
  </main>
</div>

<!-- Spinner -->
<div id="loadingOverlay" style="display:none; position:fixed; z-index:9999; inset:0;
  background:rgba(255,255,255,0.8); align-items:center; justify-content:center; flex-direction:column;">
  <div class="spinner-border text-primary" role="status" style="width:4rem; height:4rem;">
    <span class="visually-hidden">Loading...</span>
  </div>
  <p class="mt-3 fw-semibold">Processing your booking...</p>
</div>

<script src="../assets/js/bootstrap.bundle.min.js"></script>
<script>
  const form = document.getElementById('bookingForm');
  const photoUpload = document.getElementById('photoUpload');
  const photoPreview = document.getElementById('photoPreview');
  const uploadProgress = document.getElementById('uploadProgress');
  const progressBar = uploadProgress.querySelector('.progress-bar');
  const statusMessage = document.getElementById('statusMessage');

  let uploadedPhotoKeys = [];
  let currentBookingId = null;

  photoUpload.addEventListener('change', () => {
    photoPreview.innerHTML = '';
    [...photoUpload.files].forEach(file => {
      const reader = new FileReader();
      reader.onload = e => {
        const img = document.createElement('img');
        img.src = e.target.result;
        img.classList.add('preview-img', 'img-thumbnail', 'mt-2');
        img.style.maxWidth = '200px';
        photoPreview.appendChild(img);
      };
      reader.readAsDataURL(file);
    });
  });

  async function uploadPhotos(files, petSpecies) {
    uploadedPhotoKeys = [];
    uploadProgress.classList.remove('d-none');

    for (let i = 0; i < files.length; i++) {
      const file = files[i];
      const presignRes = await fetch(`${window.PETSTAY_CONFIG.API_BASE_URL}/upload-url`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          petSpecies: petSpecies,
          contentType: file.type
        })
      });

      if (!presignRes.ok) throw new Error(`Failed to get presigned URL for ${file.name}`);

      const { uploadUrl, key } = await presignRes.json();
      await fetch(uploadUrl, { method: "PUT", headers: { "Content-Type": file.type }, body: file });

      uploadedPhotoKeys.push(key);

      progressBar.style.width = `${((i + 1) / files.length) * 100}%`;
      progressBar.textContent = `${Math.round(((i + 1) / files.length) * 100)}%`;
    }
  }

  function saveBookingToSession(data) {
    const keys = [
      "BookingID", "OwnerName", "Email", "PhoneNumber",
      "PetName", "PetSpecies", "PetBreed", "PetAge",
      "CheckInDate", "CheckOutDate", "ArrivalTime"
    ];
    keys.forEach(key => sessionStorage.setItem(key, data[key] ?? ""));
    if (data.QRCodeURL) sessionStorage.setItem("QRCodeURL", data.QRCodeURL);
    if (data.QRBase64) sessionStorage.setItem("QRCodeBase64", data.QRBase64);
    if (data.QRCodeBase64) sessionStorage.setItem("QRCodeBase64", data.QRCodeBase64);
  }

  function generateQRCodeBase64(text) {
    return new Promise(resolve => {
      const tempDiv = document.createElement('div');
      new QRCode(tempDiv, { text, width: 200, height: 200 });
      setTimeout(() => {
        const img = tempDiv.querySelector('img');
        resolve(img ? img.src : tempDiv.querySelector('canvas').toDataURL("image/png"));
      }, 500);
    });
  }

  async function pollBooking() {
    for (let attempt = 0; attempt < 20; attempt++) {
      const res = await fetch(`${window.PETSTAY_CONFIG.BOOKINGS_API_URL}/${currentBookingId}`);
      if (res.ok) {
        const booking = await res.json();
        if (booking.BookingID) {
          if (!booking.QRCodeURL && !booking.QRBase64 && !booking.QRCodeBase64) {
            booking.QRBase64 = await generateQRCodeBase64(booking.BookingID);
          }
          saveBookingToSession(booking);
          window.location.href = `booking-success.html?bookingId=${encodeURIComponent(currentBookingId)}`;
          return;
        }
      }
      await new Promise(res => setTimeout(res, 2000));
    }
    statusMessage.textContent = "Booking confirmation timed out.";
    statusMessage.className = "alert alert-danger mt-4";
    statusMessage.classList.remove('d-none');
  }

  form.addEventListener('submit', async e => {
    e.preventDefault();
    const formData = Object.fromEntries(new FormData(form).entries());

    await uploadPhotos(photoUpload.files, formData.PetSpecies);
    formData.PhotoKeys = uploadedPhotoKeys;

    const res = await fetch(`${window.PETSTAY_CONFIG.BOOKINGS_API_URL}/bookings`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(formData)
    });

    if (res.ok) {
      const data = await res.json();
      currentBookingId = data.BookingID;

      if (!currentBookingId) {
        statusMessage.textContent = "Error: Booking ID missing in response.";
        statusMessage.className = "alert alert-danger mt-4";
        statusMessage.classList.remove('d-none');
        return;
      }

      statusMessage.textContent = "Booking submitted! Waiting for confirmation...";
      statusMessage.className = "alert alert-info mt-4";
      statusMessage.classList.remove('d-none');

      pollBooking();
    } else {
      statusMessage.textContent = "Error submitting booking.";
      statusMessage.className = "alert alert-danger mt-4";
      statusMessage.classList.remove('d-none');
    }
  });
</script>
</body>
</html>
