<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>New Booking | PetStay</title>
  <link rel="stylesheet" href="../assets/css/bootstrap.min.css" />
  <link rel="stylesheet" href="../assets/css/main.css" />
  <style>
    /* Fullscreen overlay */
    #loadingOverlay {
      position: fixed;
      inset: 0;
      background: rgba(255, 255, 255, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
  </style>
</head>
<body>
  <main class="main-wrapper">
    <section class="booking-form-section">
      <div class="container pt-5">
        <h2 class="fw-bold mb-4">Make a New Booking</h2>
        <form id="bookingForm">
          <!-- Form fields -->
          <div class="mb-3">
            <label for="OwnerName" class="form-label">Owner Name</label>
            <input type="text" class="form-control" id="OwnerName" name="OwnerName" required>
          </div>
          <div class="mb-3">
            <label for="Email" class="form-label">Email</label>
            <input type="email" class="form-control" id="Email" name="Email" required>
          </div>
          <div class="mb-3">
            <label for="PhoneNumber" class="form-label">Phone Number</label>
            <input type="tel" class="form-control" id="PhoneNumber" name="PhoneNumber" required>
          </div>
          <div class="mb-3">
            <label for="PetName" class="form-label">Pet Name</label>
            <input type="text" class="form-control" id="PetName" name="PetName" required>
          </div>
          <div class="mb-3">
            <label for="PetSpecies" class="form-label">Pet Species</label>
            <select class="form-control" id="PetSpecies" name="PetSpecies" required>
              <option value="">Select</option>
              <option value="Dog">Dog</option>
              <option value="Cat">Cat</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="PetBreed" class="form-label">Pet Breed</label>
            <input type="text" class="form-control" id="PetBreed" name="PetBreed" required>
          </div>
          <div class="mb-3">
            <label for="PetAge" class="form-label">Pet Age</label>
            <input type="number" class="form-control" id="PetAge" name="PetAge" required>
          </div>
          <div class="mb-3">
            <label for="CheckInDate" class="form-label">Check-in Date</label>
            <input type="date" class="form-control" id="CheckInDate" name="CheckInDate" required>
          </div>
          <div class="mb-3">
            <label for="CheckOutDate" class="form-label">Check-out Date</label>
            <input type="date" class="form-control" id="CheckOutDate" name="CheckOutDate" required>
          </div>
          <div class="mb-3">
            <label for="ArrivalTime" class="form-label">Arrival Time</label>
            <input type="time" class="form-control" id="ArrivalTime" name="ArrivalTime" required>
          </div>
          <div class="mb-3">
            <label for="photoUpload" class="form-label">Upload Pet Photo(s)</label>
            <input type="file" class="form-control" id="photoUpload" name="photoUpload" multiple>
            <div id="photoPreview" class="mt-2"></div>
          </div>
          <div class="progress mt-2 d-none" id="uploadProgress">
            <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%">0%</div>
          </div>
          <button type="submit" class="btn btn-primary mt-3">Submit Booking</button>
        </form>
        <div id="statusMessage" class="d-none mt-4"></div>
      </div>
    </section>
  </main>

  <!-- Spinner Overlay -->
  <div id="loadingOverlay">
    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <script src="../assets/js/config.js"></script>
  <script src="../assets/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

<script>
  const form = document.getElementById("bookingForm");
  const loadingOverlay = document.getElementById("loadingOverlay");
  const photoUpload = document.getElementById("photoUpload");
  const photoPreview = document.getElementById("photoPreview");
  const progressBar = document.getElementById("progressBar");
  const uploadProgress = document.getElementById("uploadProgress");
  const statusMessage = document.getElementById("statusMessage");

  let uploadedPhotoKeys = [];
  let currentBookingId = null;

  function showLoadingOverlay() { loadingOverlay.style.display = 'flex'; }
  function hideLoadingOverlay() { loadingOverlay.style.display = 'none'; }

  function generateQRCodeBase64(text) {
    return new Promise(resolve => {
      const tempDiv = document.createElement('div');
      new QRCode(tempDiv, { text, width: 200, height: 200 });
      setTimeout(() => {
        const img = tempDiv.querySelector('img');
        resolve(img ? img.src : tempDiv.querySelector('canvas').toDataURL("image/png"));
      }, 500);
    });
  }

  // Photo preview
  photoUpload.addEventListener('change', () => {
    photoPreview.innerHTML = '';
    [...photoUpload.files].forEach(file => {
      const reader = new FileReader();
      reader.onload = e => {
        const img = document.createElement('img');
        img.src = e.target.result;
        img.classList.add('preview-img', 'img-thumbnail', 'mt-2');
        img.style.maxWidth = '200px';
        photoPreview.appendChild(img);
      };
      reader.readAsDataURL(file);
    });
  });

async function uploadPhotos(files, petSpecies) {
  uploadedPhotoKeys = [];
  uploadProgress.classList.remove('d-none');

  for (let i = 0; i < files.length; i++) {
    const file = files[i];

    // Request presigned URL without sending contentType
    const presignRes = await fetch(window.PETSTAY_CONFIG.PET_PHOTO_UPLOAD_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        petSpecies,
        uploadExpiresIn: 600
      })
    });

    if (!presignRes.ok) {
      throw new Error(`Failed to get presigned URL: ${await presignRes.text()}`);
    }

    const { uploadUrl, key } = await presignRes.json();

    // PUT file to S3 without Content-Type header
    const putRes = await fetch(uploadUrl, {
      method: "PUT",
      body: file,
      mode: "cors"
    });

    if (!putRes.ok) {
      throw new Error(`Failed to upload ${file.name} to storage`);
    }

    uploadedPhotoKeys.push(key);

    const percent = Math.round(((i + 1) / files.length) * 100);
    progressBar.style.width = `${percent}%`;
    progressBar.textContent = `${percent}%`;

    if (key) {
      const permanentUrl = `https://petstayphotos.s3.amazonaws.com/${key}`;
      console.log("Permanent View URL:", permanentUrl);

      const img = document.createElement('img');
      img.src = permanentUrl;
      img.alt = file.name;
      img.classList.add('preview-img', 'img-thumbnail', 'mt-2');
      img.style.maxWidth = '200px';
      photoPreview.appendChild(img);
    }
  }
}

  function saveBookingToSession(data) {
    const keys = [
      "BookingID", "OwnerName", "Email", "PhoneNumber",
      "PetName", "PetSpecies", "PetBreed", "PetAge",
      "CheckInDate", "CheckOutDate", "ArrivalTime"
    ];
    keys.forEach(key => sessionStorage.setItem(key, data[key] ?? ""));

    let qrBase64 = data.qrCodeBase64 || data.QRCodeBase64 || '';
    if (qrBase64 && !qrBase64.startsWith("data:image")) {
      qrBase64 = `data:image/png;base64,${qrBase64}`;
    }
    sessionStorage.setItem('QRCodeBase64', qrBase64);
    sessionStorage.setItem('QRCodeURL', data.qrCodeURL || data.QRCodeURL || '');
  }

  async function pollBooking() {
    const MAX_POLL_ATTEMPTS = 60;
    for (let attempt = 0; attempt < MAX_POLL_ATTEMPTS; attempt++) {
      const res = await fetch(`${window.PETSTAY_CONFIG.BOOKINGS_API_URL}/${currentBookingId}`, { mode: "cors" });
      if (res.ok) {
        const booking = await res.json();
        if (booking.BookingID) {
          if (!booking.QRCodeURL && !booking.QRBase64 && !booking.QRCodeBase64) {
            saveBookingToSession(booking);
            hideLoadingOverlay();
            window.location.href = `booking-success.html?bookingId=${encodeURIComponent(currentBookingId)}&retry=1`;
            return;
          }
          saveBookingToSession(booking);
          hideLoadingOverlay();
          window.location.href = `booking-success.html?bookingId=${encodeURIComponent(currentBookingId)}`;
          return;
        }
      }
      await new Promise(res => setTimeout(res, 2000));
    }
    hideLoadingOverlay();
    window.location.href = `booking-success.html?bookingId=${encodeURIComponent(currentBookingId)}&retry=1`;
  }

  form.addEventListener('submit', async e => {
    e.preventDefault();
    showLoadingOverlay();

    try {
      const formData = Object.fromEntries(new FormData(form).entries());
      await uploadPhotos(photoUpload.files, formData.PetSpecies);
      formData.PhotoKeys = uploadedPhotoKeys;

      // Create booking
      const res = await fetch(window.PETSTAY_CONFIG.NEW_BOOKING_API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData),
        mode: "cors"
      });

      if (res.ok) {
        const data = await res.json();
        currentBookingId = data.bookingid || data.bookingId || data.BookingID || null;
        if (!currentBookingId) {
          hideLoadingOverlay();
          statusMessage.textContent = "Error: Booking ID missing in response.";
          statusMessage.className = "alert alert-danger mt-4";
          statusMessage.classList.remove('d-none');
          return;
        }
        statusMessage.textContent = "Booking submitted! Waiting for confirmation...";
        statusMessage.className = "alert alert-info mt-4";
        statusMessage.classList.remove('d-none');
        pollBooking();
      } else {
        hideLoadingOverlay();
        statusMessage.textContent = "Error submitting booking.";
        statusMessage.className = "alert alert-danger mt-4";
        statusMessage.classList.remove('d-none');
      }
    } catch (err) {
      hideLoadingOverlay();
      statusMessage.textContent = `Error: ${err.message}`;
      statusMessage.className = "alert alert-danger mt-4";
      statusMessage.classList.remove('d-none');
    }
  });
</script>
</body>
</html>
