<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>New Booking | PetStay</title>
  <link rel="stylesheet" href="../assets/css/bootstrap.min.css" />
  <link rel="stylesheet" href="../assets/css/main.css" />
  <link rel="stylesheet" href="../assets/css/customer.css" />
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <script src="/assets/js/config.js"></script>
  <style>
    .preview-img {
      width: 100px;
      height: 100px;
      object-fit: cover;
      border-radius: 8px;
      margin: 5px;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>
  <div class="container py-5">
    <h2 class="mb-4">New Booking</h2>
    <form id="bookingForm">
      <div class="mb-3">
        <label class="form-label">Owner Name</label>
        <input type="text" class="form-control" name="OwnerName" required>
      </div>
      <div class="mb-3">
        <label class="form-label">Email</label>
        <input type="email" class="form-control" name="Email" required>
      </div>
      <div class="mb-3">
        <label class="form-label">Phone Number</label>
        <input type="text" class="form-control" name="PhoneNumber" required>
      </div>
      <div class="mb-3">
        <label class="form-label">Pet Name</label>
        <input type="text" class="form-control" name="PetName" required>
      </div>
      <div class="mb-3">
        <label class="form-label">Species</label>
        <input type="text" class="form-control" name="PetSpecies">
      </div>
      <div class="mb-3">
        <label class="form-label">Breed</label>
        <input type="text" class="form-control" name="PetBreed">
      </div>
      <div class="mb-3">
        <label class="form-label">Age</label>
        <input type="number" class="form-control" name="PetAge">
      </div>
      <div class="mb-3">
        <label class="form-label">Check-In Date</label>
        <input type="date" class="form-control" name="CheckInDate" required>
      </div>
      <div class="mb-3">
        <label class="form-label">Check-Out Date</label>
        <input type="date" class="form-control" name="CheckOutDate" required>
      </div>
      <div class="mb-3">
        <label class="form-label">Arrival Time</label>
        <input type="time" class="form-control" name="ArrivalTime">
      </div>
      <div class="mb-3">
        <label class="form-label">Pet Photo(s)</label>
        <input type="file" class="form-control" id="photoUpload" multiple accept="image/*">
        <div id="photoPreview" class="d-flex flex-wrap mt-2"></div>
      </div>
      <button type="submit" class="btn btn-primary">Submit Booking</button>
    </form>

    <div id="uploadProgress" class="progress mt-3 d-none">
      <div class="progress-bar" role="progressbar" style="width:0%">0%</div>
    </div>

    <div id="statusMessage" class="alert mt-4 d-none"></div>
  </div>

  <script src="../assets/js/bootstrap.bundle.min.js"></script>
  <script>
    const form = document.getElementById('bookingForm');
    const photoUpload = document.getElementById('photoUpload');
    const photoPreview = document.getElementById('photoPreview');
    const uploadProgress = document.getElementById('uploadProgress');
    const progressBar = uploadProgress.querySelector('.progress-bar');
    const statusMessage = document.getElementById('statusMessage');

    let uploadedPhotoURLs = [];

    // Preview thumbnails
    photoUpload.addEventListener('change', () => {
      photoPreview.innerHTML = '';
      [...photoUpload.files].forEach(file => {
        const reader = new FileReader();
        reader.onload = e => {
          const img = document.createElement('img');
          img.src = e.target.result;
          img.classList.add('preview-img');
          photoPreview.appendChild(img);
        };
        reader.readAsDataURL(file);
      });
    });

    // Upload to S3 (mocked here â€” replace with real S3 upload logic)
    async function uploadPhotos(files) {
      uploadedPhotoURLs = [];
      uploadProgress.classList.remove('d-none');
      for (let i = 0; i < files.length; i++) {
        progressBar.style.width = `${((i + 1) / files.length) * 100}%`;
        progressBar.textContent = `${Math.round(((i + 1) / files.length) * 100)}%`;
        await new Promise(res => setTimeout(res, 300));
        uploadedPhotoURLs.push(`https://s3.example.com/${files[i].name}`);
      }
    }

    // Save all data to sessionStorage
    function saveBookingToSession(data) {
      const keys = [
        "BookingID", "OwnerName", "Email", "PhoneNumber",
        "PetName", "PetSpecies", "PetBreed", "PetAge",
        "CheckInDate", "CheckOutDate", "ArrivalTime"
      ];
      keys.forEach(key => sessionStorage.setItem(key, data[key] ?? ""));
      if (data.QRCodeURL) sessionStorage.setItem("QRCodeURL", data.QRCodeURL);
      if (data.QRBase64) sessionStorage.setItem("QRCodeBase64", data.QRBase64);
    }

    // Generate QR code if API doesn't return one
    function generateQRCodeBase64(text) {
      return new Promise(resolve => {
        const tempDiv = document.createElement('div');
        const qr = new QRCode(tempDiv, { text, width: 200, height: 200 });
        setTimeout(() => {
          const img = tempDiv.querySelector('img');
          if (img) {
            resolve(img.src);
          } else {
            const canvas = tempDiv.querySelector('canvas');
            resolve(canvas.toDataURL("image/png"));
          }
        }, 500);
      });
    }

    // Poll booking status
    async function pollBooking(bookingId) {
      for (let attempt = 0; attempt < 20; attempt++) {
        const res = await fetch(`${window.PETSTAY_CONFIG.BOOKINGS_API_URL}/${bookingId}`);
        if (res.ok) {
          const booking = await res.json();
          if (booking.BookingID) {
            if (!booking.QRCodeURL && !booking.QRBase64) {
              booking.QRBase64 = await generateQRCodeBase64(booking.BookingID);
            }
            saveBookingToSession(booking);
            window.location.href = `booking-success.html?bookingId=${encodeURIComponent(bookingId)}`;
            return;
          }
        }
        await new Promise(res => setTimeout(res, 2000));
      }
      statusMessage.textContent = "Booking confirmation timed out.";
      statusMessage.className = "alert alert-danger mt-4";
      statusMessage.classList.remove('d-none');
    }

    // Handle form submit
    form.addEventListener('submit', async e => {
      e.preventDefault();
      const formData = Object.fromEntries(new FormData(form).entries());

      await uploadPhotos(photoUpload.files);
      formData.PhotoURLs = uploadedPhotoURLs;

      // Submit booking to NEW_BOOKING_API_URL
      const res = await fetch(window.PETSTAY_CONFIG.NEW_BOOKING_API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData)
      });

      if (res.ok) {
        const { bookingId } = await res.json();
        statusMessage.textContent = "Booking submitted! Waiting for confirmation...";
        statusMessage.className = "alert alert-info mt-4";
        statusMessage.classList.remove('d-none');
        pollBooking(bookingId);
      } else {
        statusMessage.textContent = "Error submitting booking.";
        statusMessage.className = "alert alert-danger mt-4";
        statusMessage.classList.remove('d-none');
      }
    });
  </script>
</body>
</html>
