<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>New Booking | PetStay</title>
  <link rel="stylesheet" href="../assets/css/bootstrap.min.css" />
  <link rel="stylesheet" href="../assets/css/main.css" />
  <link rel="stylesheet" href="../assets/css/customer.css" />
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <script src="/assets/js/config.js"></script>
  <style>
    .preview-img {
      width: 100px;
      height: 100px;
      object-fit: cover;
      border-radius: 8px;
      margin: 5px;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>
  <div class="container py-5">
    <h2 class="mb-4">New Booking</h2>
    <form id="bookingForm">
      <div class="mb-3">
        <label for="OwnerName" class="form-label">Owner Name</label>
        <input type="text" name="OwnerName" id="OwnerName" class="form-control" required />
      </div>
      <div class="mb-3">
        <label for="PetSpecies" class="form-label">Pet Species</label>
        <select name="PetSpecies" id="PetSpecies" class="form-control" required>
          <option value="">Select species</option>
          <option value="Dog">Dog</option>
          <option value="Cat">Cat</option>
        </select>
      </div>
      <div class="mb-3">
        <label for="photoUpload" class="form-label">Pet Photos</label>
        <input type="file" id="photoUpload" multiple accept="image/jpeg,image/png" class="form-control" />
        <div id="photoPreview" class="mt-2 d-flex"></div>
      </div>
      <button type="submit" class="btn btn-primary">Submit Booking</button>
    </form>

    <div id="uploadProgress" class="progress mt-3 d-none">
      <div class="progress-bar" role="progressbar" style="width:0%">0%</div>
    </div>

    <div id="statusMessage" class="alert mt-4 d-none"></div>
  </div>

  <script src="../assets/js/bootstrap.bundle.min.js"></script>
  <script>
    const form = document.getElementById('bookingForm');
    const photoUpload = document.getElementById('photoUpload');
    const photoPreview = document.getElementById('photoPreview');
    const uploadProgress = document.getElementById('uploadProgress');
    const progressBar = uploadProgress.querySelector('.progress-bar');
    const statusMessage = document.getElementById('statusMessage');

    let uploadedPhotoKeys = [];
    let currentBookingId = null;

    photoUpload.addEventListener('change', () => {
      photoPreview.innerHTML = '';
      [...photoUpload.files].forEach(file => {
        const reader = new FileReader();
        reader.onload = e => {
          const img = document.createElement('img');
          img.src = e.target.result;
          img.classList.add('preview-img');
          photoPreview.appendChild(img);
        };
        reader.readAsDataURL(file);
      });
    });

    async function uploadPhotos(files, petSpecies) {
      uploadedPhotoKeys = [];
      uploadProgress.classList.remove('d-none');

      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const presignRes = await fetch(`${window.PETSTAY_CONFIG.API_BASE_URL}/upload-url`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            petSpecies: petSpecies,
            contentType: file.type
          })
        });

        if (!presignRes.ok) {
          throw new Error(`Failed to get presigned URL for ${file.name}`);
        }

        const { uploadUrl, key } = await presignRes.json();
        await fetch(uploadUrl, {
          method: "PUT",
          headers: { "Content-Type": file.type },
          body: file
        });

        uploadedPhotoKeys.push(key);

        progressBar.style.width = `${((i + 1) / files.length) * 100}%`;
        progressBar.textContent = `${Math.round(((i + 1) / files.length) * 100)}%`;
      }
    }

    function saveBookingToSession(data) {
      const keys = [
        "BookingID", "OwnerName", "Email", "PhoneNumber",
        "PetName", "PetSpecies", "PetBreed", "PetAge",
        "CheckInDate", "CheckOutDate", "ArrivalTime"
      ];
      keys.forEach(key => sessionStorage.setItem(key, data[key] ?? ""));
      if (data.QRCodeURL) sessionStorage.setItem("QRCodeURL", data.QRCodeURL);
      if (data.QRBase64) sessionStorage.setItem("QRCodeBase64", data.QRBase64);
      if (data.QRCodeBase64) sessionStorage.setItem("QRCodeBase64", data.QRCodeBase64);
    }

    function generateQRCodeBase64(text) {
      return new Promise(resolve => {
        const tempDiv = document.createElement('div');
        const qr = new QRCode(tempDiv, { text, width: 200, height: 200 });
        setTimeout(() => {
          const img = tempDiv.querySelector('img');
          resolve(img ? img.src : tempDiv.querySelector('canvas').toDataURL("image/png"));
        }, 500);
      });
    }

    async function pollBooking() {
      for (let attempt = 0; attempt < 20; attempt++) {
        const res = await fetch(`${window.PETSTAY_CONFIG.BOOKINGS_API_URL}/${currentBookingId}`);
        if (res.ok) {
          const booking = await res.json();
          if (booking.BookingID) {
            if (!booking.QRCodeURL && !booking.QRBase64 && !booking.QRCodeBase64) {
              booking.QRBase64 = await generateQRCodeBase64(booking.BookingID);
            }
            saveBookingToSession(booking);
            window.location.href = `booking-success.html?bookingId=${encodeURIComponent(currentBookingId)}`;
            return;
          }
        }
        await new Promise(res => setTimeout(res, 2000));
      }
      statusMessage.textContent = "Booking confirmation timed out.";
      statusMessage.className = "alert alert-danger mt-4";
      statusMessage.classList.remove('d-none');
    }

    form.addEventListener('submit', async e => {
      e.preventDefault();
      const formData = Object.fromEntries(new FormData(form).entries());

      await uploadPhotos(photoUpload.files, formData.PetSpecies);
      formData.PhotoKeys = uploadedPhotoKeys;

      // ðŸ”¹ Updated to always POST to /bookings
      const res = await fetch(`${window.PETSTAY_CONFIG.BOOKINGS_API_URL}/bookings`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData)
      });

      if (res.ok) {
        const data = await res.json();
        currentBookingId = data.BookingID;

        if (!currentBookingId) {
          statusMessage.textContent = "Error: Booking ID missing in response.";
          statusMessage.className = "alert alert-danger mt-4";
          statusMessage.classList.remove('d-none');
          return;
        }

        statusMessage.textContent = "Booking submitted! Waiting for confirmation...";
        statusMessage.className = "alert alert-info mt-4";
        statusMessage.classList.remove('d-none');

        pollBooking();
      } else {
        statusMessage.textContent = "Error submitting booking.";
        statusMessage.className = "alert alert-danger mt-4";
        statusMessage.classList.remove('d-none');
      }
    });
  </script>
</body>
</html>
