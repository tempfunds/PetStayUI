<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Booking Successful | PetStay</title>
  <link rel="stylesheet" href="../assets/css/bootstrap.min.css" />
  <link rel="stylesheet" href="../assets/css/main.css" />
  <link rel="stylesheet" href="../assets/css/customer.css" />
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
</head>
<body>
  <div class="confirmation-wrapper">
    <main class="main-wrapper">
      <section class="booking-success-section">
        <div class="container text-center pt-5">
          <h2 id="thankYouTitle" class="fw-bold mb-2">Booking Confirmed!</h2>
          <p class="text-muted">Thank you for choosing PetStay. Use the QR code below for check-in.</p>

          <div class="qr-card mx-auto mt-4" style="display:none">
            <h5 class="fw-semibold mb-3">Your Check-In QR Code</h5>
            <div id="bookingDetails" class="mb-3 text-start"></div>
            <div id="qrcode" class="qr-code-wrapper mb-3"></div>
            <button id="downloadQR" class="btn btn-primary w-100 mt-3">Download QR Code</button>
            <button onclick="window.print()" class="btn btn-outline-secondary mt-2 w-100">Print This Page</button>
            <p class="small text-muted mt-3">Please present this QR code at the reception during check-in.</p>
            <div id="toast-msg" class="alert alert-success mt-3 d-none" role="alert">QR Code Downloaded</div>
          </div>

          <a href="new-booking.html" class="btn btn-secondary mt-4">Make Another Booking</a>
        </div>
      </section>
    </main>
  </div>

  <script src="../assets/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const bookingData = {
      bookingId: sessionStorage.getItem('BookingID'),
      ownerName: sessionStorage.getItem('OwnerName'),
      email: sessionStorage.getItem('Email'),
      phoneNumber: sessionStorage.getItem('PhoneNumber'),
      petName: sessionStorage.getItem('PetName'),
      petSpecies: sessionStorage.getItem('PetSpecies'),
      petBreed: sessionStorage.getItem('PetBreed'),
      petAge: sessionStorage.getItem('PetAge'),
      checkInDate: sessionStorage.getItem('CheckInDate'),
      checkOutDate: sessionStorage.getItem('CheckOutDate'),
      arrivalTime: sessionStorage.getItem('ArrivalTime'),
      qrCodeURL: sessionStorage.getItem('QRCodeURL'),
      qrCodeBase64: sessionStorage.getItem('QRCodeBase64')
    };

    const title = document.getElementById('thankYouTitle');
    const qrCard = document.querySelector('.qr-card');
    const qrWrapper = document.getElementById('qrcode');
    const detailsDiv = document.getElementById('bookingDetails');

    if (!bookingData.bookingId) {
      qrWrapper.innerHTML = "<p class='text-danger'>No booking found. Please try again.</p>";
      return;
    }

    if (bookingData.ownerName) {
      const capName = bookingData.ownerName.charAt(0).toUpperCase() + bookingData.ownerName.slice(1);
      title.innerText = `Thank you, ${capName}!`;
    }

    detailsDiv.innerHTML = `
      <p><strong>Owner:</strong> ${bookingData.ownerName || '—'} (${bookingData.email || '—'}, ${bookingData.phoneNumber || '—'})</p>
      <p><strong>Pet:</strong> ${bookingData.petName || '—'} — ${bookingData.petSpecies ? bookingData.petSpecies.charAt(0).toUpperCase() + bookingData.petSpecies.slice(1) : '—'} (${bookingData.petBreed || '—'}), Age: ${bookingData.petAge || '—'}</p>
      <p><strong>Dates:</strong> ${bookingData.checkInDate || '—'} → ${bookingData.checkOutDate || '—'}</p>
      <p><strong>Arrival Time:</strong> ${bookingData.arrivalTime || '—'}</p>
      <p><strong>Booking ID:</strong> ${bookingData.bookingId}</p>
    `;

    const qrSrc = bookingData.qrCodeBase64 ? `data:image/png;base64,${bookingData.qrCodeBase64}` : bookingData.qrCodeURL;
    if (qrSrc) {
      const img = document.createElement('img');
      img.src = qrSrc;
      img.alt = "QR Code";
      img.style.width = '200px';
      img.style.height = '200px';
      img.style.display = 'block';
      img.style.margin = '0 auto';
      qrWrapper.appendChild(img);
      qrCard.style.display = 'block';

      confetti({ particleCount: 80, spread: 70, origin: { y: 0.6 } });

      document.getElementById('downloadQR').addEventListener('click', () => {
        const link = document.createElement('a');
        link.href = img.src;
        link.download = `PetStay-Booking-${bookingData.bookingId}.png`;
        link.click();
        const toast = document.getElementById('toast-msg');
        toast.classList.remove('d-none');
        setTimeout(() => toast.classList.add('d-none'), 3000);
      });
    } else {
      qrWrapper.innerHTML = "<p class='text-warning'>No QR code available for this booking.</p>";
    }
  });
  </script>
</body>
</html>
