<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Booking Successful | PetStay</title>
  <link rel="stylesheet" href="../assets/css/bootstrap.min.css" />
  <link rel="stylesheet" href="../assets/css/main.css" />
  <link rel="stylesheet" href="../assets/css/customer.css" />
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
</head>
<body>
  <div class="confirmation-wrapper">
    <main class="main-wrapper">
      <section class="booking-success-section">
        <div class="container text-center pt-5">
          <h2 id="thankYouTitle" class="fw-bold mb-2">Booking Confirmed!</h2>
          <p class="text-muted">Thank you for choosing PetStay. Use the QR code below for check-in.</p>

          <div class="qr-card mx-auto mt-4" style="display:none">
            <h5 class="fw-semibold mb-3">Your Check-In QR Code</h5>
            <div id="bookingDetails" class="mb-3 text-start"></div>
            <div id="qrcode" class="qr-code-wrapper mb-3"></div>
            <button id="downloadQR" class="btn btn-primary w-100 mt-3">Download QR Code</button>
            <button onclick="window.print()" class="btn btn-outline-secondary mt-2 w-100">Print This Page</button>

            <!-- Retry button -->
            <button id="retryQR" class="btn btn-warning w-100 mt-2" style="display:none">
              Retry Loading QR Code
            </button>

            <p class="small text-muted mt-3">Please present this QR code at the reception during check-in.</p>
            <div id="toast-msg" class="alert alert-success mt-3 d-none" role="alert">QR Code Downloaded</div>
          </div>

          <a href="new-booking.html" class="btn btn-secondary mt-4">Make Another Booking</a>
        </div>
      </section>
    </main>
  </div>

  <script src="../assets/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const urlParams = new URLSearchParams(window.location.search);
  const retryMode = urlParams.get("retry") === "1";

  const bookingId = sessionStorage.getItem("BookingID");
  bookingIdElem.textContent = bookingId || "Unknown";

  function formatQRCodeBase64(qrBase64) {
    if (qrBase64 && !qrBase64.startsWith("data:image")) {
      return `data:image/png;base64,${qrBase64}`;
    }
    return qrBase64 || "";
  }

  function displayQRCode() {
    let qrBase64 = formatQRCodeBase64(sessionStorage.getItem("QRCodeBase64"));
    let qrUrl = sessionStorage.getItem("QRCodeURL") || "";

    if (qrBase64) {
      qrImage.src = qrBase64;
      retryQRBtn.style.display = "none";
    } else if (qrUrl) {
      qrImage.src = qrUrl;
      retryQRBtn.style.display = "none";
    } else {
      qrImage.src = "";
      retryQRBtn.style.display = "block";
    }
  }

  retryQRBtn.addEventListener("click", async () => {
    retryQRBtn.disabled = true;
    retryQRBtn.textContent = "Retrying...";

    try {
      const res = await fetch(`${window.PETSTAY_CONFIG.BOOKINGS_API_URL}/${bookingId}`, { mode: "cors" });
      if (res.ok) {
        const booking = await res.json();

        // Save booking data
        const keys = [
          "BookingID", "OwnerName", "Email", "PhoneNumber",
          "PetName", "PetSpecies", "PetBreed", "PetAge",
          "CheckInDate", "CheckOutDate", "ArrivalTime"
        ];
        keys.forEach(key => sessionStorage.setItem(key, booking[key] ?? ""));

        let qrBase64 = formatQRCodeBase64(booking.qrCodeBase64 || booking.QRCodeBase64);
        sessionStorage.setItem("QRCodeBase64", qrBase64);
        sessionStorage.setItem("QRCodeURL", booking.qrCodeURL || booking.QRCodeURL || "");

        displayQRCode();
      }
    } catch (err) {
      console.error("Retry failed:", err);
    }

    retryQRBtn.disabled = false;
    retryQRBtn.textContent = "Retry Loading QR Code";
  });

  // Show retry button immediately if in retry mode
  if (retryMode) {
    retryQRBtn.style.display = "block";
  }

  displayQRCode();
});
</script>
</body>
</html>
