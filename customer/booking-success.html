<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Booking Successful | PetStay</title>
  <link rel="stylesheet" href="../assets/css/bootstrap.min.css" />
  <link rel="stylesheet" href="../assets/css/main.css" />
  <link rel="stylesheet" href="../assets/css/customer.css" />
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <script src="/assets/js/config.js"></script>
</head>
<body>
  <div class="confirmation-wrapper">
    <main class="main-wrapper">
      <section class="booking-success-section">
        <div class="container text-center pt-5">
          <h2 class="fw-bold mb-2">Booking Confirmed!</h2>
          <p class="text-muted">Thank you for choosing PetStay. Use the QR code below for check-in.</p>

          <div class="qr-card mx-auto mt-4" style="display:none">
            <h5 class="fw-semibold mb-3">Your Check-In QR Code</h5>
            <div id="qrcode" class="qr-code-wrapper"></div>
            <button id="downloadQR" class="btn btn-primary w-100 mt-3">Download QR Code</button>
            <button onclick="window.print()" class="btn btn-outline-secondary mt-2 w-100">Print This Page</button>
            <p class="small text-muted mt-3">Please present this QR code at the reception during check-in.</p>
            <div id="toast-msg" class="alert alert-success mt-3 d-none" role="alert">QR Code Downloaded</div>
          </div>

          <div id="bookingStatusMessage" class="alert mt-4 d-none text-start" role="alert"></div>

          <a href="new-booking.html" class="btn btn-secondary mt-4">Make Another Booking</a>
        </div>
      </section>
    </main>
  </div>

  <script src="../assets/js/bootstrap.bundle.min.js"></script>
  <script src="../assets/js/main.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', async () => {
  const params = new URLSearchParams(window.location.search);
  const bookingIdFromURL = params.get('bookingId');

  const booking = {
    BookingID: sessionStorage.getItem('BookingID') || sessionStorage.getItem('bookingId') || bookingIdFromURL,
    OwnerName: sessionStorage.getItem('OwnerName') || sessionStorage.getItem('ownerName'),
    Email: sessionStorage.getItem('Email') || sessionStorage.getItem('email'),
    PhoneNumber: sessionStorage.getItem('PhoneNumber') || sessionStorage.getItem('phoneNumber'),
    PetName: sessionStorage.getItem('PetName') || sessionStorage.getItem('petName'),
    PetSpecies: sessionStorage.getItem('PetSpecies') || sessionStorage.getItem('petSpecies'),
    PetBreed: sessionStorage.getItem('PetBreed') || sessionStorage.getItem('petBreed'),
    PetAge: sessionStorage.getItem('PetAge') || sessionStorage.getItem('petAge'),
    CheckInDate: sessionStorage.getItem('CheckInDate') || sessionStorage.getItem('checkInDate'),
    CheckOutDate: sessionStorage.getItem('CheckOutDate') || sessionStorage.getItem('checkOutDate'),
    ArrivalTime: sessionStorage.getItem('ArrivalTime') || sessionStorage.getItem('arrivalTime'),
    Status: sessionStorage.getItem('Status') || sessionStorage.getItem('status'),
    QRBase64: sessionStorage.getItem('QRBase64') || sessionStorage.getItem('qrBase64'),
    QRCodeURL: sessionStorage.getItem('QRCodeURL') || sessionStorage.getItem('qrCodeUrl')
  };

  const title = document.querySelector('h2.fw-bold.mb-2');
  const qrWrapper = document.getElementById('qrcode');
  const statusBox = document.getElementById('bookingStatusMessage');
  const qrCard = document.querySelector('.qr-card');

  if (!booking.BookingID) {
    qrWrapper.innerHTML = "<p class='text-danger'>Booking ID not found. Please try again.</p>";
    return;
  }

  const capName = booking.OwnerName ? booking.OwnerName.charAt(0).toUpperCase() + booking.OwnerName.slice(1) : "";
  title.innerText = `Thank you${capName ? ', ' + capName : ''}!`;

  const showQRCode = (src) => {
    qrCard.style.display = 'block';
    const img = document.createElement('img');
    img.src = src;
    img.alt = "QR Code";
    img.style.width = '200px';
    img.style.height = '200px';
    img.style.display = 'block';
    img.style.margin = '20px auto';
    qrWrapper.appendChild(img);

    confetti({ particleCount:80, spread:70, origin:{ y:0.6 } });

    document.getElementById('downloadQR').addEventListener('click', () => {
      const link = document.createElement('a');
      link.href = img.src;
      link.download = `PetStay-Booking-${booking.BookingID}.png`;
      link.click();
      const toast = document.getElementById('toast-msg');
      toast.classList.remove('d-none');
      setTimeout(() => toast.classList.add('d-none'), 3000);
    });
  };

  const setStatusMessage = (status) => {
    let statusMsg = '';
    let alertClass = 'alert-info';
    switch (status) {
      case 'Pending':   statusMsg = 'Booking received! Please wait for admin confirmation.'; alertClass='alert-warning'; break;
      case 'Confirmed': statusMsg = 'Booking confirmed! Please bring your QR code for check-in.'; alertClass='alert-success'; break;
      case 'Checked-In':statusMsg = 'You are already checked in. Enjoy your pet’s stay!'; alertClass='alert-success'; break;
      case 'Cancelled': statusMsg = 'Your booking was cancelled. Please contact support.'; alertClass='alert-danger'; break;
      default:          statusMsg = `Booking status: ${status}`; alertClass='alert-secondary';
    }
    statusBox.textContent = statusMsg;
    statusBox.className = `alert ${alertClass} mt-4`;
    statusBox.classList.remove('d-none');
  };

  // Instant display from sessionStorage
  if (booking.OwnerName && (booking.QRBase64 || booking.QRCodeURL)) {
    qrWrapper.innerHTML = `
      <p><strong>Owner:</strong> ${booking.OwnerName} (${booking.Email || '—'}, ${booking.PhoneNumber || '—'})</p>
      <p><strong>Pet:</strong> ${booking.PetName} — ${booking.PetSpecies ? booking.PetSpecies.charAt(0).toUpperCase() + booking.PetSpecies.slice(1) : '—'} (${booking.PetBreed || '—'}), Age: ${booking.PetAge ?? '—'}</p>
      <p><strong>Dates:</strong> ${booking.CheckInDate} → ${booking.CheckOutDate}</p>
      <p><strong>Arrival Time:</strong> ${booking.ArrivalTime || '—'}</p>
      <p><strong>Booking ID:</strong> ${booking.BookingID}</p>
    `;
    showQRCode(booking.QRBase64 ? `data:image/png;base64,${booking.QRBase64}` : booking.QRCodeURL);
    setStatusMessage(booking.Status || 'Pending');
    sessionStorage.clear();
    return;
  }

  // Fallback: fetch from API
  try {
    const res = await fetch(`${window.PETSTAY_CONFIG.BOOKINGS_API_URL}/booking/${encodeURIComponent(booking.BookingID)}`);
    if (!res.ok) throw new Error("Booking not found");
    const data = await res.json();

    qrWrapper.innerHTML = `
      <p><strong>Owner:</strong> ${data.OwnerName || '—'} (${data.Email || '—'}, ${data.PhoneNumber || '—'})</p>
      <p><strong>Pet:</strong> ${data.PetName || '—'} — ${data.PetSpecies ? data.PetSpecies.charAt(0).toUpperCase() + data.PetSpecies.slice(1) : '—'} (${data.PetBreed || '—'}), Age: ${data.PetAge ?? '—'}</p>
      <p><strong>Dates:</strong> ${data.CheckInDate || '—'} → ${data.CheckOutDate || '—'}</p>
      <p><strong>Arrival Time:</strong> ${data.ArrivalTime || '—'}</p>
      <p><strong>Booking ID:</strong> ${data.BookingID || '—'}</p>
    `;

    if (["Confirmed","Checked-In","Pending"].includes(data.Status) && (data.QRCodeURL || data.QRBase64)) {
      showQRCode(data.QRBase64 ? `data:image/png;base64,${data.QRBase64}` : data.QRCodeURL);
    }
    setStatusMessage(data.Status || 'Pending');
  } catch (err) {
    qrWrapper.innerHTML = "<p class='text-danger'>Error loading booking. Please try again later.</p>";
    console.error('Fetch error:', err);
  }
});
</script>

</body>
</html>
